<?php

include_once './'. drupal_get_path('module', 'api') .'/tests/api_test_case.php';

/**
 * Tests that links are generated correctly on API pages.
 */
class ApiWebLinksTestCase extends ApiWebPagesBaseTest {
  public static function getInfo() {
    return array(
      'name' => 'Web links',
      'description' => 'Tests links on web pages for the API module.',
      'group' => 'API Module',
    );
  }

  /**
   * Tests that links are generated correctly in code.
   */
  function testInCodeLinks() {
    // Test a bunch of links on the sample_in_code_links page.
    $links = array(
      'sample_function' => 'sample.php/function/sample_function',
      'sample_one' => 'sample.php/function/theme_sample_one',
      'sample_two' => 'sample-two.tpl.php',
      'sample_three' => 'sample-three.tpl.php',
      'sample_four__option' => 'sample.php/function/theme_sample_four',
      'sample_name' => 'sample.php/function/hook_sample_name',
      'another_sample' => 'sample.php/function/hook_another_sample_alter',
      'duplicate_function' => 'search/' . $this->branch_info['branch_name'] . '/duplicate_function',
      'SubSample' => 'classes.php/class/SubSample',
      'SAMPLE_CONSTANT' => 'sample.php/constant/SAMPLE_CONSTANT',
      'DUPLICATE_CONSTANT' => 'search/' . $this->branch_info['branch_name'] . '/DUPLICATE_CONSTANT',
    );

    foreach ($links as $text => $url) {
      $this->drupalGet('api/' . $this->branch_info['project'] . '/sample.php/function/sample_in_code_links');
      $this->assertLink($text, 0, 'Link to ' . $text . ' exists');
      $this->clickLink($text);
      $this->assertTrue(strpos($this->url, $url) !== FALSE, $text . ' link went to right place');
    }

    // Test for text that should be there but not linked.
    $no_links = array(
      'nonexistent_hook',
      'nonexistent_theme_hook',
      'nonexistent_alter_name',
      'title',
    );

    $this->drupalGet('api/' . $this->branch_info['project'] . '/sample.php/function/sample_in_code_links');
    foreach ($no_links as $text) {
      $this->assertText($text, $text . ' is present');
    }
  }

  /**
   * Tests that links are generated correctly in documentation.
   */
  function testDocumentationLinks() {
    // Test a variety of links on the documentation page for sample_function().
    $links = array(
      'duplicate_function' => 'search/' . $this->branch_info['branch_name'] . '/duplicate_function',
      'http://example.com' => 'NO',
      'this is a link for the parameter' => 'NO',
      'SAMPLE_CONSTANT' => 'sample.php/constant/SAMPLE_CONSTANT',
      'Samples' => 'sample.php/group/samp_GRP-6.x',
    );

    foreach ($links as $text => $url) {
      $this->drupalGet('api/' . $this->branch_info['project'] . '/sample.php/function/sample_function');
      $this->assertLink($text, 0, 'Link to ' . $text . ' exists');
      if ($url != 'NO') {
        $this->clickLink($text);
        $this->assertTrue(strpos($this->url, $url) !== FALSE, $text . ' link went to right place');
      }
    }

    // Test some links on the duplicate_function() page.
    $links = array(
      'Subscribers' => 'sample.php/group/samp_GRP-6.x',
      'newsletters (categories)' => 'classes.php/group/class_samples',
      'subscription' => 'sample.php/group/samp_GRP-6.x',
      'newsletter issues' => 'classes.php/group/class_samples',
    );

    foreach ($links as $text => $url) {
      $this->drupalGet('api/' . $this->branch_info['project'] . '/sample.php/function/duplicate_function');
      $this->assertLink($text, 0, 'Link to ' . $text . ' exists');
      $this->clickLink($text);
      $this->assertTrue(strpos($this->url, $url) !== FALSE, $text . ' link went to right place');
    }
  }
}
